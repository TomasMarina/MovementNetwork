---
title: "DATA_WORKFLOW"
author: "T.I.M."
date: "2/12/2021"
output: html_document
---

This is a RMarkdown file. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.
Note that the `echo = FALSE` parameter was added to every code chunk to prevent printing of the R code within the document.

Setup RMarkdown file

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load needed packages

```{r packages, echo=FALSE, include=FALSE}

pkg_list <- c("dplyr", "tidyr", "igraph", "sf", "ggplot2", "gridExtra", "assertthat")

lapply(pkg_list, FUN = function(pkg_list) {
    do.call("require", list(pkg_list)) 
})

```

Generate node and link lists

```{r data_treatment, echo=FALSE, include=TRUE}

## Curate data to generate site (node) & movement (link) lists

###########
# Site list
# 'cluster' is synonym with 'site'
data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
nodes_all <- data_raw %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, frequency, no.ind) %>%
  summarise()


## Site list filtered by 'colonia'
# I chose the most visited (highest 'frequency') site as colony site
# Then I incorporated 'frequency' and 'no.ind' data into the colony site
nodes_colonia <- nodes_all %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_colonia$frequency[nodes_colonia$colonia == 1] <- sum(nodes_all[nodes_all$colonia == 1,]$frequency)
nodes_colonia$no.ind[nodes_colonia$colonia == 1] <- 5

# Day and night lists
data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
nodes_day <- data_raw %>%
  filter(hour == "16:00:00") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, id, .keep_all = TRUE) %>%
    mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  rename(dist.col = distppa) %>%
  distinct(site, .keep_all = TRUE) %>%
  rename(time = hour) %>%
  group_by(site, lon, lat, time, colonia, dist.col, frequency, no.ind) %>%
  summarise()
nodes_col_day <- nodes_day %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_day$frequency[nodes_col_day$colonia == 1] <- sum(nodes_day[nodes_day$colonia == 1,]$frequency)
nodes_col_day$no.ind[nodes_col_day$colonia == 1] <- 5

data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
nodes_night <- data_raw %>%
  filter(hour == "04:00:00") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, id, .keep_all = TRUE) %>%
    mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  rename(dist.col = distppa) %>%
  distinct(site, .keep_all = TRUE) %>%
  rename(time = hour) %>%
  group_by(site, lon, lat, time, colonia, dist.col, frequency, no.ind) %>%
  summarise()
nodes_col_night <- nodes_night %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_night$frequency[nodes_col_night$colonia == 1] <- sum(nodes_night[nodes_night$colonia == 1,]$frequency)
nodes_col_night$no.ind[nodes_col_night$colonia == 1] <- 5


# Pre and pos-penguin lists (2020-03-10)
nodes_prepen <- data_raw %>%
  filter(date <= "2020-03-10") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, frequency, no.ind) %>%
  summarise()
nodes_col_prepen <- nodes_prepen %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_prepen$site[nodes_col_prepen$colonia == 1] <- 10
nodes_col_prepen$frequency[nodes_col_prepen$colonia == 1] <- sum(nodes_prepen[nodes_prepen$colonia == 1,]$frequency)

nodes_pospen <- data_raw %>%
  filter(date > "2020-03-10") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, frequency, no.ind) %>%
  summarise()
nodes_col_pospen <- nodes_pospen %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_pospen$frequency[nodes_col_pospen$colonia == 1] <- sum(nodes_pospen[nodes_pospen$colonia == 1,]$frequency)


# Different site lists
# All sites
nodes_all
# Day
nodes_all_day <- nodes_all[nodes_all$time == 'day', ]
no_sites_all_day <- nrow(nodes_all_day)
# Night
nodes_all_night <- nodes_all[nodes_all$time == 'night', ]
no_sites_all_night <- nrow(nodes_all_night)
# Both (sites visited during day & night)
nodes_all_both <- nodes_all[nodes_all$time == 'both', ]
no_sites_all_both <- nrow(nodes_all_both)
# Colonia
nodes_colonia
no_sites_colonia <- nrow(nodes_colonia)
nodes_col_day
no_sites_col_day <- nrow(nodes_col_day)
nodes_col_night
no_sites_col_night <- nrow(nodes_col_night)
nodes_col_prepen
nodes_col_pospen

## Export site lists as .csv files
# write.csv(nodes_all, file = "../data/nodes_all.csv")
# write.csv(nodes_colonia, file = "../data/nodes_colonia.csv")
# write.csv(nodes_col_day, file = "../data/nodes_col_day.csv")
# write.csv(nodes_col_night, file = "../data/nodes_col_night.csv")
# write.csv(nodes_col_prepen, file = "../data/nodes_col_prepen.csv")
# write.csv(nodes_col_pospen, file = "../data/nodes_col_pospen.csv")


###############
# Movement list
# 'cluster' is synonym with 'site'
data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
links_all <- data_raw %>%
  rename(site = cluster) %>%
  select(id, date, lon, lat, colonia, site) %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

# Link list filtered by 'colonia' site
# Site #10 was considered as colony site, so I replaced all [colonia == 1] sites
# from 'links_all' with #10 site
links_col <- links_all
from <-  c(1:9, 11:34, 36:38, 40:41, 43:46, 48:49, 55, 58:59,
           63:65, 67, 69, 78:80, 82:84, 92, 96, 123)
to <- 10
for (i in seq_along(from))links_col$from[links_col$from==from[i]] <- to
for (i in seq_along(from))links_col$to[links_col$to==from[i]] <- to
links_colonia <- links_col %>% distinct(from, to, .keep_all = T)

# Pre and pos-penguin lists (2020-03-10)
links_col_prepen <- links_colonia %>%
  filter(date <= "2020-03-10")

links_col_pospen <- links_colonia %>%
  filter(date > "2020-03-10")

# Different link lists
# All links
links_all
# Links filtered by 'colonia'
links_colonia
no_links_colonia <- nrow(links_colonia)
links_col_prepen
links_col_pospen

## Export movement list as .csv file
# write.csv(links_all, file = "../data/links_all.csv")
# write.csv(links_colonia, file = "../data/links_colonia.csv")
# write.csv(links_col_prepen, file = "../data/links_col_prepen.csv")
# write.csv(links_col_pospen, file = "../data/links_col_pospen.csv")

```

Plot sites on Isla de los Estados map

```{r nodes_viz, echo=FALSE}

## Viz of nodes on Isla de los Estados map (idle)

## Shapefiles

# Isla de los Estados shapefile
shapefile_idle <- "../shapes_plot/idle/idle.shp" %>%
  st_read()
# Penguins' patches shapefile
# shapefile_pin <- "../shapes_plot/parches_pinguino/PPA_poly.shp" %>%
#   st_read()
# Penguins' colony shapefile
shapefile_col <- "../shapes_plot/poligono_colonia/franklin_utm.shp" %>%
  st_read()

## Plot sites on idle map

# All sites
no_sites_all <- nrow(nodes_all)
nodemap_all <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_all,
             aes(lon, lat, size = log(frequency), colour = no.ind)) +
  scale_color_gradient(low = "blue", high = "red", "# individuals") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(size = guide_legend("log(frec-visita)"), colour = guide_legend("# Individuos")) +
  labs(title = "Sites") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_all))

# All sites & shape of penguin colony
nodemap_all_penguin <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_all, aes(lon, lat), colour = "blue") +
  geom_sf(data = shapefile_col, colour = "red", fill = NA) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Striated Caracara sites and Penguins colony (red)")
  

############################
# Filtered by 'colonia' site

nodemap_colonia <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = as.factor(colonia))) +
  scale_color_manual(values = c("0" = "blue", "1" = "red")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("Colonia")) +
  labs(title = "Sites filtered by colonia") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_colonia))

nodemap_time <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = time, size = frequency)) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("Time", order = 1), size = guide_legend("Frequency", order = 2))

int_breaks <- function(x, n = 5) {
  l <- pretty(x, n)
  l[abs(l %% 1) < .Machine$double.eps ^ 0.5] 
}

nodemap_ind <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = no.ind,  size = frequency)) +
  scale_color_gradient(low = "blue", high = "red", "# individuals", breaks = int_breaks) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("# individuals", order = 1), size = guide_legend("Frequency", order = 2))

# Plots by time (day, night)
nodemap_col_day <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_col_day, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites day") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_col_day))

nodemap_col_night <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_col_night, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites night") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_col_night))


## All plots
nodemap_all
nodemap_all_penguin
grid.arrange(nodemap_col_day, nodemap_col_night, nrow = 2)
nodemap_colonia

## Save plots

# pdf("../figures/nodemap_all.pdf")
# nodemap_all
# dev.off()

# pdf("../figures/nodemap_all_penguin.pdf")
# nodemap_all_penguin
# dev.off()

# pdf("../figures/nodemap_bytime.pdf")
# grid.arrange(nodemap_col_day, nodemap_col_night, nrow = 2)
# dev.off()

# pdf("../figures/nodemap_colonia.pdf")
# nodemap_colonia
# dev.off()

# pdf("../figures/nodemaps_sites.pdf")
# grid.arrange(arrangeGrob(nodemap_ind,
#                          top = "How much and who visits the sites?"),
#              arrangeGrob(nodemap_time,
#                          top = "Time of visit and frequency"), nrow = 2)
# dev.off()

```

Create network as 'igraph' object

```{r network, echo=FALSE}

net_all <- graph_from_data_frame(links_all, directed = TRUE, vertices = nodes_all)
net_colonia <- graph_from_data_frame(links_colonia, directed = TRUE, vertices = nodes_colonia)
net_col_prepen <- graph_from_data_frame(links_col_prepen, directed = TRUE, vertices = nodes_col_prepen)
net_col_pospen <- graph_from_data_frame(links_col_pospen, directed = TRUE, vertices = nodes_col_pospen)

```

Plot networks

```{r network_viz, echo=FALSE}

#############
## Shapefiles

# Isla de los Estados shapefile
shapefile_idle <- "../shapes_plot/idle/idle.shp" %>%
  st_read()
# Penguins' patches shapefile
# shapefile_pin <- "../shapes_plot/parches_pinguino/PPA_poly.shp" %>%
#   st_read()
# Penguins' colony shapefile
shapefile_col <- "../shapes_plot/poligono_colonia/franklin_utm.shp" %>%
  st_read()


################
## Network plots
# Firstly, organize link data for plotting on map

links_all$from <- as.integer(links_all$from)
links_all$to <- as.integer(links_all$to)
links_plot_all <- links_all %>%
  inner_join(nodes_all %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_all %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_all) == nrow(links_all))

netmap_all <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_all,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_all, aes(lon, lat),
             colour = ifelse(nodes_all$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())


links_colonia$from <- as.integer(links_colonia$from)
links_colonia$to <- as.integer(links_colonia$to)
links_plot_colonia <- links_colonia %>%
  inner_join(nodes_colonia %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_colonia %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_colonia) == nrow(links_colonia))

netmap_colonia <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_colonia,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_colonia, aes(lon, lat),
             colour = ifelse(nodes_colonia$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# links:', no_links_colonia))

# Pre and pos-penguin networks (2020-03-10)
links_col_prepen$from <- as.integer(links_col_prepen$from)
links_col_prepen$to <- as.integer(links_col_prepen$to)
links_plot_col_prepen <- links_col_prepen %>%
  inner_join(nodes_col_prepen %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_col_prepen %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_col_prepen) == nrow(links_col_prepen))

netmap_col_prepen <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_col_prepen,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_col_prepen, aes(lon, lat),
             colour = ifelse(nodes_col_prepen$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Movement network Pre-penguin departure (2020-03-10)")


links_col_pospen$from <- as.integer(links_col_pospen$from)
links_col_pospen$to <- as.integer(links_col_pospen$to)
links_plot_col_pospen <- links_col_pospen %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_col_pospen) == nrow(links_col_pospen))

netmap_col_pospen <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_col_pospen,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_col_pospen, aes(lon, lat),
             colour = ifelse(nodes_col_pospen$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Movement network Pos-penguin departure (2020-03-10)")


# By individual
netmap_indE <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_colonia,
               aes(x = x, xend = xend, y = y, yend = yend, colour = ind),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  scale_color_manual(values = c("A" = "gray60", "B" = "gray60", "C" = "gray60",
                                "D" = "gray60", "E" = "red")) +
  geom_point(data = nodes_colonia, aes(lon, lat),
             colour = ifelse(nodes_colonia$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
   guides(colour = guide_legend("Individual")) +
   labs(title = "Movement network by Individual E")

## Save plots

# pdf("../figures/netmap_colonia.pdf")
# netmap_colonia
# dev.off()

# pdf("../figures/netmap_col_penguin.pdf")
# grid.arrange(netmap_col_prepen, netmap_col_pospen, nrow = 2)
# dev.off()

# pdf("../figures/netmap_indA.pdf")
# netmap_indA
# dev.off()
# pdf("../figures/netmap_indB.pdf")
# netmap_indB
# dev.off()
# pdf("../figures/netmap_indC.pdf")
# netmap_indC
# dev.off()
# pdf("../figures/netmap_indD.pdf")
# netmap_indD
# dev.off()
# pdf("../figures/netmap_indE.pdf")
# netmap_indE
# dev.off()


```

Test for movement pattern after sharing night site

```{r common_bed, echo=FALSE}

# Create data set with inds sharing night site
night_share <- data_raw %>%
  rename(site = cluster) %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  select(date, hour, site, lon, lat, ind) %>%
  filter(hour == "04:00:00") %>%
  arrange(date, site) %>%
  group_by(date, site) %>%
  filter(n() > 1)

# To be continue: check for inds movement pattern after sharing night site

```
