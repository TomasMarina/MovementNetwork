---
title: "DATA_WORKFLOW"
author: "T.I.M."
date: "2/12/2021"
output: html_document
---

This is a RMarkdown file. When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.
Note that the `echo = FALSE` parameter was added to every code chunk to prevent printing of the R code within the document.


Setup RMarkdown file

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load needed packages

```{r packages, echo=FALSE, include=FALSE}

pkg_list <- c("dplyr", "tidyr", "igraph", "sf", "ggplot2", "gridExtra", "assertthat")

lapply(pkg_list, FUN = function(pkg_list) {
    do.call("require", list(pkg_list)) 
})

```


Generate site and link lists

```{r data_treatment, echo=FALSE, include=TRUE}

## Curate data to generate site (node) & movement (link) lists

# Site lists
###########

# 'cluster' is synonym with 'site'
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_all <- data_raw %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site, distlobos, lobos) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, no.ind) %>%
  summarise()


## Site list filtered by 'colonia'
# I chose the most visited (highest 'frequency') site as colony site
# Then I incorporated 'frequency' and 'no.ind' data into the colony site
nodes_colonia <- nodes_all %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_colonia$frequency[nodes_colonia$colonia == 1] <- sum(nodes_all[nodes_all$colonia == 1,]$frequency)
nodes_colonia$no.ind[nodes_colonia$colonia == 1] <- 5



# Day and night lists
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_day <- data_raw %>%
  filter(hour == "16:00:00") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site, distlobos, lobos) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  rename(time = hour) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, no.ind) %>%
  summarise()
nodes_col_day <- nodes_day %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_day$frequency[nodes_col_day$colonia == 1] <- sum(nodes_day[nodes_day$colonia == 1,]$frequency)
nodes_col_day$no.ind[nodes_col_day$colonia == 1] <- 5

data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_night <- data_raw %>%
  filter(hour == "04:00:00") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, site, distlobos, lobos) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  rename(time = hour) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, no.ind) %>%
  summarise()
nodes_col_night <- nodes_night %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_night$frequency[nodes_col_night$colonia == 1] <- sum(nodes_night[nodes_night$colonia == 1,]$frequency)
nodes_col_night$no.ind[nodes_col_night$colonia == 1] <- 5


# Pre and pos-penguin lists (2020-03-10)
nodes_prepen <- data_raw %>%
  filter(date <= "2020-03-10") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, no.ind) %>%
  summarise()
nodes_col_prepen <- nodes_prepen %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_prepen$site[nodes_col_prepen$colonia == 1] <- 10
nodes_col_prepen$frequency[nodes_col_prepen$colonia == 1] <- sum(nodes_prepen[nodes_prepen$colonia == 1,]$frequency)

nodes_pospen <- data_raw %>%
  filter(date > "2020-03-10") %>%
  rename(site = cluster) %>%
  select(id, hour, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, id, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, id, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", hour)) %>%
  mutate(time = recode(time, "16:00:00" = "day", "04:00:00" = "night")) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, no.ind) %>%
  summarise()
nodes_col_pospen <- nodes_pospen %>%
  group_by(colonia) %>%
  filter(colonia == 0 | frequency == max(frequency))
nodes_col_pospen$frequency[nodes_col_pospen$colonia == 1] <- sum(nodes_pospen[nodes_pospen$colonia == 1,]$frequency)


# Site lists by Individual
# Individual A == "49127"
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_indA <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  filter(ind == "A") %>%
  rename(site = cluster) %>%
  mutate(time = recode(hour, "16:00:00" = "day", "04:00:00" = "night")) %>%
  select(ind, time, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, time, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", time)) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, ind) %>%
  summarise()
nodes_indA$site[nodes_indA$colonia == 1] <- 10
nodes_indA$frequency[nodes_indA$colonia == 1] <- sum(nodes_indA[nodes_indA$colonia == 1,]$frequency)
nodes_indA <- nodes_indA[!duplicated(nodes_indA$site),]

# Individual B == "49138"
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_indB <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  filter(ind == "B") %>%
  rename(site = cluster) %>%
  mutate(time = recode(hour, "16:00:00" = "day", "04:00:00" = "night")) %>%
  select(ind, time, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, time, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", time)) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, ind) %>%
  summarise()
nodes_indB$site[nodes_indB$colonia == 1] <- 10
nodes_indB$frequency[nodes_indB$colonia == 1] <- sum(nodes_indB[nodes_indB$colonia == 1,]$frequency)
nodes_indB <- nodes_indB[!duplicated(nodes_indB$site),]

# Individual C == "49152"
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_indC <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  filter(ind == "C") %>%
  rename(site = cluster) %>%
  mutate(time = recode(hour, "16:00:00" = "day", "04:00:00" = "night")) %>%
  select(ind, time, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, time, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", time)) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, ind) %>%
  summarise()
nodes_indC$site[nodes_indC$colonia == 1] <- 10
nodes_indC$frequency[nodes_indC$colonia == 1] <- sum(nodes_indC[nodes_indC$colonia == 1,]$frequency)
nodes_indC <- nodes_indC[!duplicated(nodes_indC$site),]

# Individual D == "49178"
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_indD <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  filter(ind == "D") %>%
  rename(site = cluster) %>%
  mutate(time = recode(hour, "16:00:00" = "day", "04:00:00" = "night")) %>%
  select(ind, time, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, time, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", time)) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, ind) %>%
  summarise()
nodes_indD$site[nodes_indD$colonia == 1] <- 10
nodes_indD$frequency[nodes_indD$colonia == 1] <- sum(nodes_indD[nodes_indD$colonia == 1,]$frequency)
nodes_indD <- nodes_indD[!duplicated(nodes_indD$site),]

# Individual E == "49180"
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
nodes_indE <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  filter(ind == "E") %>%
  rename(site = cluster) %>%
  mutate(time = recode(hour, "16:00:00" = "day", "04:00:00" = "night")) %>%
  select(ind, time, lon, lat, distppa, colonia, distlobos, lobos, site) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, time, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(time = if_else(site.dup == "TRUE", "both", time)) %>%
  rename(dist.col = distppa, dist.lob = distlobos) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(site, lon, lat, time, colonia, dist.col, dist.lob, lobos, frequency, ind) %>%
  summarise()
nodes_indE$site[nodes_indE$colonia == 1] <- 10
nodes_indE$frequency[nodes_indE$colonia == 1] <- sum(nodes_indE[nodes_indE$colonia == 1,]$frequency)
nodes_indE <- nodes_indE[!duplicated(nodes_indE$site),]


# Different site lists
# All sites
nodes_all
# Day
nodes_all_day <- nodes_all[nodes_all$time == 'day', ]
no_sites_all_day <- nrow(nodes_all_day)
# Night
nodes_all_night <- nodes_all[nodes_all$time == 'night', ]
no_sites_all_night <- nrow(nodes_all_night)
# Both (sites visited during day & night)
nodes_all_both <- nodes_all[nodes_all$time == 'both', ]
no_sites_all_both <- nrow(nodes_all_both)
# Colonia
nodes_colonia
no_sites_colonia <- nrow(nodes_colonia)
nodes_col_day
no_sites_col_day <- nrow(nodes_col_day)
nodes_col_night
no_sites_col_night <- nrow(nodes_col_night)
nodes_col_prepen
no_sites_col_prepen <- nrow(nodes_col_prepen)
nodes_col_pospen
no_sites_col_pospen <- nrow(nodes_col_pospen)

# Individual
nodes_indA
no_sites_indA <- nrow(nodes_indA)
nodes_indB
no_sites_indB <- nrow(nodes_indB)
nodes_indC
no_sites_indC <- nrow(nodes_indC)
nodes_indD
no_sites_indD <- nrow(nodes_indD)
nodes_indE
no_sites_indE <- nrow(nodes_indE)

## Export site lists as .csv files
# write.csv(list_name, file = "../data/list_name.csv")


# Movement (link) lists
###############

# 'cluster' is synonym with 'site'
data_raw <- read.csv("../data/datos_nov2020_colonia_lobos.csv", sep = ",", header = TRUE)
links_all <- data_raw %>%
  rename(site = cluster) %>%
  select(id, date, lon, lat, colonia, site) %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

# Link list filtered by 'colonia' site
# Site #10 was considered as colony site, so I replaced all [colonia == 1] sites
# from 'links_all' with #10 site
links_col <- links_all
from <-  c(1:9, 11:34, 36:38, 40:41, 43:46, 48:49, 55, 58:59,
           63:65, 67, 69, 78:80, 82:84, 92, 96, 123)
to <- 10
for (i in seq_along(from))links_col$from[links_col$from==from[i]] <- to
for (i in seq_along(from))links_col$to[links_col$to==from[i]] <- to
links_colonia <- links_col %>% distinct(from, to, .keep_all = T)


# Pre and pos-penguin lists (2020-03-10)
links_col_prepen <- links_colonia %>%
  filter(date <= "2020-03-10")

links_col_pospen <- links_colonia %>%
  filter(date > "2020-03-10")


# Link lists by Individual
links_indA <- links_colonia %>%
  filter(ind == "A")

links_indB <- links_colonia %>%
  filter(ind == "B")

links_indC <- links_colonia %>%
  filter(ind == "C")

links_indD <- links_colonia %>%
  filter(ind == "D")

links_indE <- links_colonia %>%
  filter(ind == "E")


# Different link lists
# All links
links_all
# Links filtered by 'colonia'
links_colonia
no_links_colonia <- nrow(links_colonia)
links_col_prepen
no_links_col_prepen <- nrow(links_col_prepen)
links_col_pospen
no_links_col_pospen <- nrow(links_col_pospen)
links_indA
no_links_indA <- nrow(links_indA)
links_indB
no_links_indB <- nrow(links_indB)
links_indC
no_links_indC <- nrow(links_indC)
links_indD
no_links_indD <- nrow(links_indD)
links_indE
no_links_indE <- nrow(links_indE)

## Export movement list as .csv file
# write.csv(list_name, file = "../data/list_name.csv")


```


Plot sites on Isla de los Estados map

```{r sites_viz, echo=FALSE}

## Viz of nodes on Isla de los Estados map (idle)

## Shapefiles

# Isla de los Estados shapefile
shapefile_idle <- "../shapes_plot/idle/idle.shp" %>%
  st_read()
# Penguins' patches shapefile
# shapefile_pin <- "../shapes_plot/parches_pinguino/PPA_poly.shp" %>%
#   st_read()
# Penguins' colony shapefile
shapefile_col <- "../shapes_plot/poligono_colonia/franklin_utm.shp" %>%
  st_read()

## Plot sites on idle map

# All sites
no_sites_all <- nrow(nodes_all)
nodemap_all <- ggplot() +
  geom_sf(data = shapefile_idle) + 
  geom_point(data = nodes_all,
              aes(lat, lon, size = log(frequency), colour = no.ind)) +
  scale_color_gradient(low = "blue", high = "red", "# individuals") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(size = guide_legend("log(frec-visita)"), colour = guide_legend("# Individuos")) +
  labs(title = "Sites") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_all))


# All sites & shape of penguin colony
nodemap_all_penguin <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_all, aes(lon, lat), colour = "blue") +
  geom_sf(data = shapefile_col, colour = "red", fill = NA) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Striated Caracara sites and Penguins colony (red)")
  

############################
# Filtered by 'colonia' site

no_sites_colonia <- nrow(nodes_colonia)
nodemap_colonia <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = as.factor(colonia))) +
  scale_color_manual(values = c("0" = "blue", "1" = "red")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("Colonia")) +
  labs(title = "Sites filtered by colonia") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_colonia))

nodemap_time <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = time, size = frequency)) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("Time", order = 1), size = guide_legend("Frequency", order = 2))

int_breaks <- function(x, n = 5) {
  l <- pretty(x, n)
  l[abs(l %% 1) < .Machine$double.eps ^ 0.5] 
}

nodemap_ind <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = no.ind,  size = frequency)) +
  scale_color_gradient(low = "blue", high = "red", "# individuals", breaks = int_breaks) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("# individuals", order = 1), size = guide_legend("Frequency", order = 2))

# Plots by time (day, night)
nodemap_col_day <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_col_day, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites day") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_col_day))

nodemap_col_night <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_col_night, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites night") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_col_night))


## All plots
nodemap_all
nodemap_all_penguin
grid.arrange(nodemap_col_day, nodemap_col_night, nrow = 2)
nodemap_colonia

## Save plots

# pdf("../figures/plot_name.pdf")
# plot_name
# dev.off()

# pdf("../figures/nodemap_bytime.pdf")
# grid.arrange(nodemap_col_day, nodemap_col_night, nrow = 2)
# dev.off()

# pdf("../figures/nodemaps_sites.pdf")
# grid.arrange(arrangeGrob(nodemap_ind, top = "How much and who visits the sites?"),
#              arrangeGrob(nodemap_time, top = "Time of visit and frequency"),
#              nrow = 2)
# dev.off()

```


Create network as 'igraph' object

```{r network, echo=FALSE}

net_all <- graph_from_data_frame(links_all, directed = TRUE, vertices = nodes_all)
net_colonia <- graph_from_data_frame(links_colonia, directed = TRUE, vertices = nodes_colonia)
net_col_prepen <- graph_from_data_frame(links_col_prepen, directed = TRUE, vertices = nodes_col_prepen)
net_col_pospen <- graph_from_data_frame(links_col_pospen, directed = TRUE, vertices = nodes_col_pospen)
net_col_indA <- graph_from_data_frame(links_indA, directed = TRUE, vertices = nodes_indA)
net_col_indB <- graph_from_data_frame(links_indB, directed = TRUE, vertices = nodes_indB)
net_col_indC <- graph_from_data_frame(links_indC, directed = TRUE, vertices = nodes_indC)
net_col_indD <- graph_from_data_frame(links_indD, directed = TRUE, vertices = nodes_indD)
net_col_indE <- graph_from_data_frame(links_indE, directed = TRUE, vertices = nodes_indE)


```


Plot networks

```{r network_viz, echo=FALSE}

#############
## Shapefiles

# Isla de los Estados shapefile
shapefile_idle <- "../shapes_plot/idle/idle.shp" %>%
  st_read()
# Penguins' patches shapefile
# shapefile_pin <- "../shapes_plot/parches_pinguino/PPA_poly.shp" %>%
#   st_read()
# Penguins' colony shapefile
shapefile_col <- "../shapes_plot/poligono_colonia/franklin_utm.shp" %>%
  st_read()


################
## Network plots
# Firstly, organize link data for plotting on map

links_all$from <- as.integer(links_all$from)
links_all$to <- as.integer(links_all$to)
links_plot_all <- links_all %>%
  inner_join(nodes_all %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_all %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_all) == nrow(links_all))

netmap_all <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_all,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_all, aes(lon, lat),
             colour = ifelse(nodes_all$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())


links_colonia$from <- as.integer(links_colonia$from)
links_colonia$to <- as.integer(links_colonia$to)
links_plot_colonia <- links_colonia %>%
  inner_join(nodes_colonia %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_colonia %>% select(site, lon, lat), by = c('to' = 'site')) %>% 
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_colonia) == nrow(links_colonia))

netmap_colonia <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_colonia,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_colonia, aes(lon, lat),
             colour = ifelse(nodes_colonia$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label= paste('# links:', no_links_colonia)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust=1, hjust=-.1, label=paste('# sites:', no_sites_colonia))

netmap_colonia_outdeg <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_colonia,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_colonia, aes(lon, lat,
                                       colour = V(net_colonia)$out.deg/sum(V(net_colonia)$out.deg))) +
  scale_color_gradient(low = "yellow", high = "red", na.value = NA) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Conexiones de salida", colour = "Proporción") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label= paste('# links:', no_links_colonia)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust=1, hjust=-.1, label=paste('# sites:', no_sites_colonia))

# Pre and pos-penguin networks (2020-03-10)
links_col_prepen$from <- as.integer(links_col_prepen$from)
links_col_prepen$to <- as.integer(links_col_prepen$to)
links_plot_col_prepen <- links_col_prepen %>%
  inner_join(nodes_col_prepen %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_col_prepen %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_col_prepen) == nrow(links_col_prepen))

netmap_col_prepen <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_col_prepen,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_col_prepen, aes(lon, lat),
             colour = ifelse(nodes_col_prepen$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Movement network Pre-penguin departure (2020-03-10)") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label= paste('# links:', no_links_col_prepen)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust=1, hjust=-.1, label=paste('# sites:', no_sites_col_prepen))


links_col_pospen$from <- as.integer(links_col_pospen$from)
links_col_pospen$to <- as.integer(links_col_pospen$to)
links_plot_col_pospen <- links_col_pospen %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_col_pospen) == nrow(links_col_pospen))

netmap_col_pospen <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_col_pospen,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_col_pospen, aes(lon, lat),
             colour = ifelse(nodes_col_pospen$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Movement network Pos-penguin departure (2020-03-10)") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label= paste('# links:', no_links_col_pospen)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust=1, hjust=-.1, label=paste('# sites:', no_sites_col_pospen))


# By individual
# Change 'geom_segment' colour in 'scale_color_manual' to highlight ind
netmap_indE <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_colonia,
               aes(x = x, xend = xend, y = y, yend = yend, colour = ind),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  scale_color_manual(values = c("A" = "gray60", "B" = "gray60", "C" = "gray60",
                                "D" = "gray60", "E" = "red")) +
  geom_point(data = nodes_colonia, aes(lon, lat),
             colour = ifelse(nodes_colonia$colonia == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
   guides(colour = guide_legend("Individual")) +
   labs(title = "Movement network by Individual E") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label= paste('# links:', no_links_indE)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust=1, hjust=-.1, label=paste('# sites:', no_sites_indE))

## Save plots

# pdf("../figures/netmap_colonia_outdeg.pdf")
# netmap_colonia_outdeg
# dev.off()

# pdf("../figures/netmap_col_penguin.pdf")
# grid.arrange(netmap_col_prepen, netmap_col_pospen, nrow = 2)
# dev.off()


```


Sites and movement pattern after sharing night site

```{r share_night, echo=FALSE}

## Create dataset with inds sharing night site

data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
night_share <- data_raw %>%
  rename(site = cluster) %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  select(date, hour, site, lon, lat, ind) %>%
  filter(hour == "04:00:00") %>%
  arrange(date, site) %>%
  group_by(date, site) %>%
  filter(n() > 1)


## Sites visited and movement pattern before and after sharing night site

# Comparison between inds B and E before and after sharing site 6 on "2020-02-26"
# Sites visited
site_indB6_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "B") %>%
  filter(date <= "2020-02-16") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()
  
site_indB6_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "B") %>%
  filter(date > "2020-02-16") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()

site_indE_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "E") %>%
  filter(date <= "2020-02-16") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()

site_indE_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "E") %>%
  filter(date > "2020-02-16") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()

sitemap_indB6_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indB6_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indB6_bef, site_indB6_bef$site == 6),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind B before sharing night site")
  
sitemap_indB6_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indB6_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind B after sharing night site")

sitemap_indE_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indE_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indE_bef, site_indE_bef$site == 6),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind E before sharing night site")

sitemap_indE_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indE_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind E after sharing night site")


# pdf("../figures/nodemap_share_indsBE.pdf")
# grid.arrange(sitemap_indB6_bef, sitemap_indB6_aft, sitemap_indE_bef, sitemap_indE_aft,
#              nrow = 2)
# dev.off()


# Comparison between inds A and B before and after sharing site 153 on "2020-05-03"
site_indA_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "A") %>%
  filter(date <= "2020-05-03") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()
  
site_indA_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "A") %>%
  filter(date > "2020-05-03") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()

site_indB1_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "B") %>%
  filter(date <= "2020-05-03") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()

site_indB1_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  rename(dist.col = distppa) %>%
  filter(ind == "B") %>%
  filter(date > "2020-05-03") %>%
  select(date, hour, site, lon, lat, colonia, dist.col, ind) %>%
  add_count(site) %>%
  rename(frequency = n) %>%
  distinct(site, hour, ind, .keep_all = TRUE) %>%
  mutate(site.dup = ifelse(duplicated(site) | duplicated(site, fromLast = TRUE),
                              "TRUE", "FALSE")) %>%
  distinct(site, ind, .keep_all = TRUE) %>%
  group_by(site) %>%
  mutate(no.ind = nrow(data.frame(site))) %>%
  distinct(site, .keep_all = TRUE) %>%
  group_by(date, site, frequency, lon, lat, colonia, dist.col, ind) %>%
  summarise()


sitemap_indA_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indA_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indA_bef, site_indA_bef$site == 153),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind A before sharing night site")

sitemap_indA_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indA_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind A after sharing night site")

sitemap_indB1_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indB1_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indB1_bef, site_indB1_bef$site == 153),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind B before sharing night site")

sitemap_indB1_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = site_indB1_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Sites of ind B after sharing night site")


# pdf("../figures/nodemap_share_indsAB.pdf")
# grid.arrange(sitemap_indA_bef, sitemap_indA_aft, sitemap_indB1_bef, sitemap_indB1_aft,
#              nrow = 2)
# dev.off()


# Movement pattern
data_raw <- read.csv("../data/datos_nov2020.csv", sep = ",", header = TRUE)
links_indA_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  filter(ind == "A") %>%
  filter(date <= "2020-05-03") %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

links_indA_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  filter(ind == "A") %>%
  filter(date > "2020-05-03") %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

links_indB1_bef <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  filter(ind == "B") %>%
  filter(date <= "2020-05-03") %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

links_indB1_aft <- data_raw %>%
  mutate(ind = factor(id, levels = c("49127", "49138", "49152", "49178", "49180"),
              labels = c("A", "B", "C", "D", "E"))) %>%
  rename(site = cluster) %>%
  filter(ind == "B") %>%
  filter(date > "2020-05-03") %>%
  select(ind, date, lon, lat, colonia, site) %>%
  mutate(from = paste(site), to = NA) %>%
  arrange(ind, date) %>%
  mutate(to = ifelse(is.na(to), lead(from), to)) %>%
  group_by(ind) %>%
  mutate(to = replace(to, n(), NA)) %>%
  distinct(from, to, .keep_all = TRUE) %>%
  select(from, to, ind, date) %>%
  drop_na()

# Plot movement pattern
# Firstly, structure link data for plotting on map
links_indA_bef$from <- as.integer(links_indA_bef$from)
links_indA_bef$to <- as.integer(links_indA_bef$to)
links_plot_indA_bef <- links_indA_bef %>%
  inner_join(site_indA_bef %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(site_indA_bef %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_indA_bef) == nrow(links_indA_bef))

links_indA_aft$from <- as.integer(links_indA_aft$from)
links_indA_aft$to <- as.integer(links_indA_aft$to)
links_plot_indA_aft <- links_indA_aft %>%
  inner_join(site_indA_aft %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(site_indA_aft %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_indA_aft) == nrow(links_indA_aft))

links_indB1_bef$from <- as.integer(links_indB1_bef$from)
links_indB1_bef$to <- as.integer(links_indB1_bef$to)
links_plot_indB1_bef <- links_indB1_bef %>%
  inner_join(site_indB1_bef %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(site_indB1_bef %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_indB1_bef) == nrow(links_indB1_bef))

links_indB1_aft$from <- as.integer(links_indB1_aft$from)
links_indB1_aft$to <- as.integer(links_indB1_aft$to)
links_plot_indB1_aft <- links_indB1_aft %>%
  inner_join(site_indB1_aft %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(site_indB1_aft %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_indB1_aft) == nrow(links_indB1_aft))


netmap_indA_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_indA_bef,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = site_indA_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indA_bef, site_indA_bef$site == 153),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Network ind A before sharing night site")

netmap_indA_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_indA_aft,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = site_indA_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Network ind A after sharing night site")

netmap_indB1_bef <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_indB1_bef,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = site_indB1_bef, aes(lon, lat), colour = "blue") +
  geom_point(data = subset(site_indB1_bef, site_indB1_bef$site == 153),
     aes(lon, lat, colour = "red"), show.legend = FALSE) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Network ind B before sharing night site")

netmap_indB1_aft <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_indB1_aft,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = site_indB1_aft, aes(lon, lat), colour = "blue") +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Network ind B after sharing night site")


# pdf("../figures/netmap_share_indsAB.pdf")
# grid.arrange(netmap_indA_bef, netmap_indA_aft, netmap_indB1_bef, netmap_indB1_aft,
#              nrow = 2)
# dev.off()

```


Network analysis

```{r network_analysis, echo=FALSE}

## Network 'igraph' objects

net_colonia <- graph_from_data_frame(links_colonia, directed = TRUE, vertices = nodes_colonia)
net_col_prepen <- graph_from_data_frame(links_col_prepen, directed = TRUE, vertices = nodes_col_prepen)
net_col_pospen <- graph_from_data_frame(links_col_pospen, directed = TRUE, vertices = nodes_col_pospen)


## Centrality indices

# Degree
V(net_colonia)$tot.deg <- degree(net_colonia, mode = "total")
V(net_colonia)$in.deg <- degree(net_colonia, mode = "in")
V(net_colonia)$out.deg <- degree(net_colonia, mode = "out")
vertex.attributes(net_colonia)

data_totdeg <- degree(net_colonia, mode = "total")
hist_deg <- ggplot(data.frame(data_totdeg), aes(x = data.frame(data_totdeg)[,1])) +
  geom_bar() +
  labs(x = "Cantidad de conexiones totales", y = "Frecuencia")
data_indeg <- degree(net_colonia, mode = "in")
hist_indeg <- ggplot(data.frame(data_indeg), aes(x = data.frame(data_indeg)[,1])) +
  geom_bar() +
  labs(x = "Cantidad de conexiones de entrada", y = "Frecuencia")
data_outdeg <- degree(net_colonia, mode = "out")
hist_outdeg <- ggplot(data.frame(data_outdeg), aes(x = data.frame(data_outdeg)[,1])) +
  geom_bar() +
  labs(x = "Cantidad de conexiones de salida", y = "Frecuencia")

# pdf("../figures/hist_deg.pdf")
# hist_deg
# dev.off()

```


Analysis of lobos data

```{r lobos_analysis, echo=FALSE}

## Análisis de sitios lobos

# Se necesitan los siguientes objetos:
nodes_colonia
nodes_col_pospen
links_colonia
links_col_pospen
shapefile_idle
links_plot_colonia
links_plot_col_pospen
net_colonia
net_col_pospen


## Gráfico de sitios lobos
no_sites_lobos <- length(which(nodes_colonia$lobos == "1"))

nodemap_col_lobos <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_point(data = nodes_colonia, aes(lon, lat, colour = as.factor(lobos))) +
  scale_color_manual(values = c("0" = "blue", "1" = "red")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(colour = guide_legend("Lobos")) +
  labs(title = "Sitios colonias de lobos") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# sites:', no_sites_lobos))


## Histograma de visitas absolutas (registros GPS) y conexiones de sitios lobos pos-partida de pingüinos
lobos_pos <- subset(nodes_col_pospen, lobos == "1")
hist_vis <- ggplot(lobos_pos, aes(x = lobos_pos$frequency)) +
  geom_bar() +
  labs(x = "Sitios asociados a colonias de lobos", y = "Frecuencia de visita")

degree_lob <- degree(net_col_pospen, v = V(net_col_pospen)$lobos == "1", mode = "total")
hist_con <- ggplot(data.frame(degree_lob), aes(x = data.frame(degree_lob)[,1])) +
  geom_bar() +
  labs(x = "Sitios asociados a colonias de lobos", y = "Frecuencia de conexiones")

# Conteo e identificación de conexiones de sitios lobos en red total y red pos-partida de pingüinos
no_links_lobos <- sum(degree(net_colonia, v = V(net_colonia)$lobos == "1", mode = "total"))
links_lobos <- incident_edges(net_colonia, v = V(net_colonia)$lobos == "1", mode = "all")

no_links_lobos_pos <- sum(degree(net_col_pospen, v = V(net_col_pospen)$lobos == "1", mode = "total"))
links_lobos_pos <- incident_edges(net_col_pospen, v = V(net_col_pospen)$lobos == "1", mode = "all")


## Gráfico de red marcando conexiones hacia sitios lobos en red pos-partida de pingüinos
# Diámetro de sitios lobos por conexiones totales (hacia y desde) en red pos-partida de pingüinos
degree <- degree(net_col_pospen, mode = "total")

links_col_pospen$from <- as.integer(links_col_pospen$from)
links_col_pospen$to <- as.integer(links_col_pospen$to)
links_plot_col_pospen <- links_col_pospen %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('from' = 'site')) %>%
  rename(x = lon, y = lat) %>%
  inner_join(nodes_col_pospen %>% select(site, lon, lat), by = c('to' = 'site')) %>%
  rename(xend = lon, yend = lat)
assert_that(nrow(links_plot_col_pospen) == nrow(links_col_pospen))

links_plot_col_pospen$lobos <- ifelse(links_plot_col_pospen$to %in% c("77", "81", "85", "90", "91", "93", "100", "109", "110", "114", "128", "130", "135", "139", "140", "142", "143", "144", "145", "146", "147", "149", "150", "154", "155", "158", "162", "163", "166", "167", "178", "181"), "1", "0")
no_links_to_lobos <- sum(links_plot_col_pospen$lobos == "1")

netmap_col_lobos_con <- ggplot() +
  geom_sf(data = shapefile_idle) +
  geom_segment(data = links_plot_col_pospen,
               aes(x = x, xend = xend, y = y, yend = yend),
               arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
               colour = ifelse(links_plot_col_pospen$lobos == 1, "red", "gray60"),
               size = 0.5, alpha = 0.5) +
  geom_point(data = nodes_col_pospen, aes(lon, lat, size = degree*0.75),
             colour = ifelse(nodes_col_pospen$lobos == 1, "red", "blue")) +
  theme_bw() +
  theme(axis.line = element_line(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none") +
  annotate(geom = "text", x = Inf, y = Inf, vjust=1, hjust=1, label=paste('# links:', no_links_to_lobos)) +
  annotate(geom = "text", x = -Inf, y = Inf, vjust = 1, hjust = -.1, label=paste('# sites:', no_sites_lobos))

# pdf(file = "../figures/hist_shortest_lobos.pdf")
# hist_cam
# dev.off()

## Calcular caminos más cortos desde sitio colonia ("10") hacia los 32 sitios lobos
caminos <- shortest.paths(net_colonia, v = V(net_colonia)$colonia == "1", to = V(net_colonia)$lobos == "1", mode = "out")
caminos <- data.frame(caminos)
caminos <- reshape(caminos, varying = list(names(caminos)[1:32]), v.names = "Frecuencia", timevar = "Sitios", direction = "long")
hist_cam <- ggplot(caminos, aes(x = Frecuencia)) +
  geom_bar() +
  labs(x = "Shortest paths between colony and sea lions sites", y = "Frequency")

```
